'use strict';var host='http://62.16.29.73',port=3002,root=host+':'+port,ODESSA='588cf6e7d263bce41074cf0c',LVIV='588cf6e7d263bce41074cf0d',currentCity,authorized,phoneRegExp=/^(?:\+?38)?0\d{9}$/,emailRegExp=/^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,order={orderItems:[],sum:0,customerInfo:{}},storesItems={};$(document).ready(function(){isAuthorized(),$('.modal').modal(),$('#city-modal').modal({dismissible:!0,opacity:.5,inDuration:300,outDuration:200,startingTop:'4%',endingTop:'30%'}),window.addEventListener('hashchange',function(){render(decodeURI(window.location.hash))}),currentCity=getCookie('cityId'),window.dispatchEvent(new HashChangeEvent('hashchange')),''==currentCity&&$('#city-modal').modal('open'),Handlebars.registerHelper('deliveryButtonText',function(a){return'preparing'==a?'\u0412\u0437\u044F\u0442\u044C \u0437\u0430\u043A\u0430\u0437':'delivering'==a?'\u0414\u043E\u0441\u0442\u0430\u0432\u043A\u0430 \u043E\u043A\u043E\u043D\u0447\u0435\u043D\u0430':void 0}),Handlebars.registerHelper('processing',function(a,b){if('processing'==b)return'<a class="btn col xs12 s5 operatorConfirmButton" onclick="operatorConfirmButton(\''+a+'\');">\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C</a>'})});function render(a){var b=a.split('/')[0],f=document.querySelector('.fixed-action-btn');f.classList.contains('scale-out')&&(f.classList.remove('scale-out'),f.classList.add('scale-in'));for(var g=document.querySelectorAll('.main-content .page'),h=0,k=g.length;h<k;h++)g[h].classList.remove('visible');var l={'':function(){renderInitialPage()},'#store':function(){var n=a.split('#store/')[1].trim();renderStorePage(n)},'#cart':function(){f.classList.contains('scale-in')&&f.classList.remove('scale-in'),f.classList.add('scale-out'),renderCartPage()},'#delivery':function(){renderDeliveryPage()},'#register':function(){renderRegisterPage()},'#account':function(){authorized==void 0?xhr('GET','/api/v1/session/status',{},function(n,o){return 400<=n?void console.error(n):void(authorized=o.authorized,renderAccountPage())}):renderAccountPage()}};l[b]?l[b]():renderErrorPage()}function renderTemplate(a,b,f,g){var h=document.getElementById(b).innerHTML;Handlebars.registerHelper('prettifyDate',function(n){return new Date(n).toLocaleString('ru-RU')});var k=Handlebars.compile(h),l=k(f);if(document.getElementById(g).innerHTML=l,null!==a){var m=document.querySelector(a);m.classList.add('visible')}}function renderAccountPage(){authorized?(xhr('GET','/api/v1/orders',{},function(a,b){return 400<=a?(window.location.hash='#',$('#loginModal').modal('open'),void console.error(a)):void(0===b.orders.length?renderTemplate('.account.page','emptyOrdersTemplate',{},'userOrders'):(renderTemplate('.account.page','userOrdersTemplate',b,'userOrders'),$('.collapsible').collapsible()),$('.account.page ul.tabs').tabs())}),xhr('GET','/api/v1/delivery/orders',{},function(a,b){400>a?(0===b.orders.length?renderTemplate(null,'emptyDeliveryOrdersTemplate',{},'deliveryOrders'):(renderTemplate(null,'deliveryOrdersTemplate',b,'deliveryOrders'),$('.collapsible').collapsible()),document.getElementById('deliveryTab').style.display='block'):document.getElementById('deliveryTab').style.display='none'}),xhr('GET','/api/v1/operator/orders',{},function(a,b){400>a?(console.log(b),0===b.orders.length?renderTemplate(null,'emptyOperatorOrdersTemplate',{},'operatorOrders'):(renderTemplate(null,'operatorOrdersTemplate',b,'operatorOrders'),$('.collapsible').collapsible()),document.getElementById('operatorTab').style.display='block'):document.getElementById('operatorTab').style.display='none'})):(window.location.hash='#',$('#loginModal').modal('open'))}function renderDeliveryPage(){document.querySelector('.delivery.page').classList.add('visible')}function renderRegisterPage(){document.querySelector('.register.page').classList.add('visible')}function renderInitialPage(){0===Object.keys(storesItems).length&&storesItems.constructor===Object&&xhr('GET','/api/v1/storetypes',{cityId:currentCity},function(a,b){if(400<=a)return void console.error(a);renderTemplate(null,'storetypelist-template',b,'navHorizontal-allstores');for(var f=document.querySelectorAll('#navHorizontal-allstores li'),g=function(m){f[m].addEventListener('click',function(){renderStoresOfType(currentCity,b.storetypes[m]._id)},!1)},h=0,k=f.length;h<k;h++)g(h,k);renderTemplate(null,'storelistUL-template',b,'store-list'),$('ul.tabs').tabs(),$('ul.tabs').tabs('select_tab',b.storetypes[0]._id),document.getElementById('tab'+b.storetypes[0]._id).dispatchEvent(new Event('click'))}),0===Object.keys(storesItems).length&&$('ul.tabs').tabs(),window.location.hash='#',document.querySelector('.all-stores.page').classList.add('visible')}function renderCartPage(){renderTemplate('.shopping-cart.page','shopping-cart-template',order,'shopping-cart-list')}function renderStorePage(a){var b=document.querySelector('.single-store.page');xhr('GET','/api/v1/items',{storeId:a},function(f,g){return 400<=f?void console.error(f):void renderTemplate('.single-store.page','single-store-template',g,'single-store-row')}),xhr('GET','/api/v1/stores',{_id:a},function(f,g){return 400<=f?void console.error(f):void renderTemplate(null,'storename-template',g.stores[0],'storename')}),b.style.height=parseInt(b.style.height)+60+'px',b.classList.add('visible')}function renderStores(a,b){renderTemplate(null,'storelist-template',a,b);for(var f=document.getElementById(b).children,g=function(l){var m=f[l].id;f[l].addEventListener('click',function(){window.location.hash='store/'+m},!1)},h=0;h<f.length;h++)g(h)}function renderStoresOfType(a,b){void 0!==storesItems[b]?renderStores(storesItems[b],b):xhr('GET','/api/v1/stores',{cityId:a,typeId:b},function(f,g){return 400<=f?void console.error(f):void renderStores(g,b)})}function renderErrorPage(){}function updateUserInfo(){xhr('GET','/api/v1/users',{},function(a,b){if(400<=a)return void console.error(a);var f=document.querySelector('#changedStreet'),g=document.querySelector('#changedHouse'),h=document.querySelector('#changedName'),k=document.querySelector('#changedPhoneNumber'),l=document.querySelector('#name'),m=document.querySelector('#phone_number'),n=document.querySelector('#street'),o=document.querySelector('#house');l.value=h.value=b.name,m.value=k.value=b.phone,n.value=f.value=b.street?b.street:'',o.value=g=b.house?b.house:'',Materialize.updateTextFields()})}function changeQuantityByInput(a,b,f,g){var h=f.split('');f='';for(var k=document.querySelector('.quantity.id'+a),l=0,m=h.length;l<m;l++)0<=h[l]&&9>=h[l]&&' '!==h[l]&&(f+=h[l]);k.value=f,''==f&&(f=0);var n=getItemAndStoreFromCart(a,b),o=n.storeIndex,q=n.itemIndex;if(null!==o&&null!==q&&0<=f){var r=order.orderItems[o].items[q].sum;order.orderItems[o].items[q].quantity=f,order.orderItems[o].items[q].sum=f*g,order.sum+=f*g-r,0>order.sum&&(order.sum=0),document.querySelector('.total-sum').innerHTML=order.sum;var s=document.querySelector('.sum.id'+a);s.innerHTML=order.orderItems[o].items[q].sum,updateBadge()}}function incrementItemButton(a,b,f,g){var k=document.querySelector('.quantity.id'+a);if(0<=k.value){incrementItem(a,b,f,g,!0);var l=document.querySelector('.sum.id'+a);l.innerHTML=+l.innerHTML+ +f}k.value=+k.value+1}function incrementItem(a,b,f,g,h){var k=getItemAndStoreFromCart(a,b),l=k.storeIndex,m=k.itemIndex;if(null===l){var n={};n.id=b,n.items=[],l=order.orderItems.push(n)-1,xhr('GET','/api/v1/stores',{_id:b},function(q,r){return 400<=q?void console.error(q):void(order.orderItems[l].name=r.stores[0].name,order.orderItems[l].image=r.stores[0].image,order.orderItems[l].address=r.stores[0].address)})}if(null===m){var o={};o.id=a,o.name=g,o.quantity=o.sum=0,o.price=f,m=order.orderItems[l].items.push(o)-1}order.orderItems[l].items[m].quantity++,order.orderItems[l].items[m].sum+=+f,order.sum+=+f,null!==document.querySelector('.total-sum')&&(document.querySelector('.total-sum').innerHTML=order.sum),updateBadge(),h||Materialize.toast('\u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D :)',2e3)}function removeFromCartButton(a,b){var g=getItemAndStoreFromCart(a,b),h=g.storeIndex,k=g.itemIndex;order.sum-=order.orderItems[h].items[k].price*order.orderItems[h].items[k].quantity,document.querySelector('.total-sum').innerHTML=order.sum,updateBadge(),order.orderItems[h].items.splice(k,1),document.querySelector('.collection-item.id'+a+'.avatar.dismissable').outerHTML='',0==order.orderItems[h].items.length&&(order.orderItems.splice(h,1),document.querySelector('.collection.with-header.id'+b).outerHTML='')}function decrementItemButton(a,b,f){var g=document.querySelector('.quantity.id'+a),h=+g.value,k=document.querySelector('.sum.id'+a);g.value=h-1,k.innerHTML=+k.innerHTML-+f,decrementItem(a,b,f)}function decrementItem(a,b,f){var g=getItemAndStoreFromCart(a,b),h=g.storeIndex,k=g.itemIndex;order.orderItems[h].items[k].quantity--,order.orderItems[h].items[k].sum-=+f,order.sum-=+f,order.orderItems[h].items[k].quantity||(order.orderItems[h].items.splice(k,1),document.querySelector('.collection-item.id'+a+'.avatar.dismissable').outerHTML='',0===order.orderItems[h].items.length&&(order.orderItems.splice(h,1),document.querySelector('.collection.with-header.id'+b).outerHTML='')),updateBadge(),document.querySelector('.total-sum').innerHTML=order.sum}function getItemAndStoreFromCart(a,b){for(var f=null,g=null,h=0,k=order.orderItems.length;h<k;h++)if(order.orderItems[h].id==b){f=h;for(var l=0,m=order.orderItems[h].items.length;l<m;l++)if(order.orderItems[h].items[l].id==a){g=l;break}break}return{storeIndex:f,itemIndex:g}}function encodeQuery(a){var b=[];for(var f in a)b.push(encodeURIComponent(f)+'='+encodeURIComponent(a[f]));return b.join('&')}function formToObject(a){var b={},f=new FormData(document.querySelector(a));f=Array.from(f.entries());for(var g=f.length,h=0;h<g;h++)b[f[h][0]]=f[h][1];return b}function submitRegistrationForm(){var a=formToObject('form.registration');a={name:a.regName,password:a.regPassword,email:a.regEmail,street:a.regStreet,house:a.regHouse,phoneNumber:a.regPhoneNumber},validateRegistrationForm(a)&&(a.cityId=currentCity,xhr('POST','/api/v1/users',a,function(b,f){return 400<=b?('duplicate'==f.reason&&'email'==f.fields[0]&&Materialize.toast('Email \u0437\u0430\u043D\u044F\u0442',3e3),void console.error(b)):void(authorize(),window.location.hash='account',$('registeredModal').modal('open'))}))}function validateRegistrationForm(a){var b=!0;return phoneRegExp.test(a.phoneNumber)||(b=!1),b}function validateOrderForm(a){var b=!0;return(0>=order.sum||!phoneRegExp.test(a.phone_number))&&(b=!1),b}function isJSON(a){try{JSON.parse(a)}catch(b){return!1}return!0}function xhr(a,b,f,g){var h=new XMLHttpRequest;h.open(a,root+b+('GET'==a?'?'+encodeQuery(f):''),!0),('POST'==a||'PUT'==a)&&h.setRequestHeader('Content-Type','application/json; charset=UTF-8'),h.onload=function(){g(h.status,isJSON(h.responseText)?JSON.parse(h.responseText):{})},h.send('POST'==a||'PUT'==a?JSON.stringify(f):null)}function clearCart(){order={orderItems:[],sum:0,customerInfo:{}}}function updateBadge(){var a=document.querySelector('.badge');a.innerHTML='\u20B4'+order.sum,a.style.display=order.sum?'block':'none'}function submitOrderForm(){var a=formToObject('form.order');validateOrderForm(a)&&(order.customerInfo=a,xhr('POST','/api/v1/orders',order,function(b){return 400<=b?void console.error(b):void(clearCart(),updateBadge(),window.location.hash='#',$('#orderedModal').modal('open'))}))}function validateLoginForm(a){var b=!0;return 5>a.password.length&&!emailRegExp.test(a.email)&&(b=!1),b}function submitLoginForm(){var a=formToObject('form.login');validateLoginForm(a)&&xhr('POST','/api/v1/session',a,function(b){return 400<=b?void alert('\u041D\u0435\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 email \u0438\u043B\u0438 \u043F\u0430\u0440\u043E\u043B\u044C'):void authorize()})}function submitSettingsForm(){var a=formToObject('form.settings');a={name:a.changedName,phone:a.changedPhoneNumber,street:a.changedStreet,house:a.changedHouse},xhr('PUT','/api/v1/users',a,function(b){return 400<=b?void Materialize.toast('\u041D\u0435\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0442\u0435\u043B\u0435\u0444\u043E\u043D\u0430'):void(updateUserInfo(),Materialize.toast('\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E',2e3))})}function isAuthorized(){xhr('GET','/api/v1/session/status',{},function(a,b){return 400<=a?void console.error(a):void(authorized=b.authorized,authorized&&updateUserInfo())})}function authorize(){$('#loginModal').modal('close'),authorized=!0,updateUserInfo(),setCookie('authorized',!0,999),window.location.hash='account'}function accountButton(){authorized?window.location.hash='account':$('#loginModal').modal('open')}function logOutButton(){xhr('DELETE','/api/v1/session',{},function(a){return 400<=a?void console.error(a):void(authorized=!1,setCookie('authorized',!1,999),window.location.hash='#')})}function shoppingCartButton(){0<order.sum?window.location.hash='#cart':Materialize.toast('\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u043F\u0443\u0441\u0442\u0430',2e3)}function deliveryButton(a,b){'preparing'===b&&xhr('PUT','/api/v1/delivery/orders',{id:a},function(f){return 403===f?void console.error('forbidden'):404===f?void console.error('order not found'):void renderAccountPage()}),'delivering'===b&&xhr('PUT','/api/v1/delivery/orders/complete',{id:a},function(f){return 403===f?void console.error('forbidden'):404===f?void console.error('order not found'):void renderAccountPage()})}function operatorConfirmButton(a){console.log(a),xhr('PUT','/api/v1/operator/orders',{id:a},function(f){return 403===f?void console.error('forbidden'):404===f?void console.error('order not found'):void renderAccountPage()})}function operatorCancelButton(a){xhr('PUT','/api/v1/operator/cancel',{id:a},function(b){return 403===b?void console.error('forbidden'):404===b?void console.error('order not found'):void renderAccountPage()})}function goBack(){window.history.back()}function trigger(){$('ul.tabs').tabs('select_tab','account-window')}function getCookie(a){for(var k,b=a+'=',f=decodeURIComponent(document.cookie),g=f.split(';'),h=0;h<g.length;h++){for(k=g[h];' '==k.charAt(0);)k=k.substring(1);if(0==k.indexOf(b))return k.substring(b.length,k.length)}return''}function setCookie(a,b,f){var g=new Date;g.setTime(g.getTime()+1e3*(60*(60*(24*f))));var h='expires='+g.toUTCString();document.cookie=a+'='+b+';'+h+';path=/'}